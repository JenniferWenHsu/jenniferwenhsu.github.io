<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<style>
  body {
    padding: 100px;
    width: 1000px;
    margin: auto;
    text-align: left;
    font-weight: 300;
    font-family: 'Open Sans', sans-serif;
    color: #121212;
  }
  h1, h2, h3, h4 {
    font-family: 'Source Sans Pro', sans-serif;
  }

 figure {
    display: inline-block;
    margin: 20px; /* adjust as needed */
}
figure img {
    vertical-align: top;
}
figure figcaption {
    text-align: center;
}
</style>
<title>CS 184 Final Project</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="https://fonts.googleapis.com/css?family=Open+Sans|Source+Sans+Pro" rel="stylesheet">
</head>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<body>

<h1 align="middle">CS 184: Computer Graphics and Imaging, Spring 2017</h1>
<h1 align="middle">Final Project Report <br> Mirage and Fata Morgana</h1>
<h2 align="middle">Sudeep Dasari, CS184-adw <br> Jennifer Hsu, CS184-abn</h2>


<br><br>

<h2> Abstract</h2>
<p> In project 3, the ray-tracing algorithm assumes that light travels in a straight line from the camera into the scene. However, there are sundry cases where a light takes on a non-linear path. For example, on a hot summer day light rays travelling parallel to the ground curves upwards into the sky, causing a non-existent pool of blue to form on the ground. Our project seeks to correctly model these optical effects using a slab based technique and a more flexible Euler integration technique. These algorithms are applied to model optical phenomena - like mirages and Fata Morgana – as well as ray trace scenes through lenses with unique optical properties. </p> 
<h2> Technical Approach </h2>
<h3> Slab Method </h3>
<h3> Modified Slab Method </h3>
<h3> Euler Integration Technique </h3>
 <p> Both slab techniques assume that index of refraction only varies with height. Obviously, this constraint is easy to violate, and ideally our algorithm would still produce viable results even in scenes with complex changes in refractive index. Solving the more general problem requires a more generalized approach. These equations – based on Fermat’s principles and presented by F.J Seron et al. – relate the index of refraction to the slope of a light ray at a point. </p>
 <table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/eq1.PNG" width="300px" />
		        <figcaption align="middle"> Source: F. J. Seron et. al. </figcaption>
		      </tr>
		</table> 

		<p> In practice this differential equation can be discretized and solved with Euler integration. </p>
		<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/eq2.PNG" width="300px" />
		        <figcaption align="middle"> Source: F. J. Seron et. al. </figcaption>
		      </tr>
		</table> 
<p> Note that this formula can easily be solved iteratively so long as the following quantities are known: the index of refraction and light ray slope at the last time step, the index of refraction at current time step, and derivative of the index of refraction function with respect to position. </p>

<h2> Results and Applications</h2> 

<h3> Gradient Index Optics Lens Application </h3>
<p> The Euler integration proved to be overkill for simple mirage and fata morgana rendering. Gradient Optics (GRIN) lenses – lenses where the index of refraction changes as a function of position – proved to be the perfect application to test the Euler integration method. Specifically, the ray tracer’s camera uses a cylindrical GRIN lens with index of refraction that varies quadratically as a function of radius. </p>

<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/grin_diagram.png" width="500px" />
		      </tr>
		</table> 
<p> The lens equations above come from the International Society for Optics and Photonics (read more <a href="https://spie.org/publications/tt48_55_gradient_index_lens">here</a>). Note that the gradient of the above index of refraction equation with respect to (x,y,z) coordinates is: </p>

<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/gradient.png" width="300px" />
		      </tr>
		</table> 
<p> Using this gradient and Euler integration rays can be traced from a point behind the lens out into the front. Below are traces generated by a python script that plot light flowing through the lens from camera position out into the world. The light takes a curved path in a GRIN lens unlike the straight path it would normally take in glass. </p>
<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/diag1.png" width="300px" />
		        <td align="middle">
		        <img src="images/diag2.png" width="300px" />
		       </tr>
		       <tr>
		        <td align="middle">
		        <img src="images/diag3.png" width="300px" />
		        <td align="middle">
		        <img src="images/diag4.png" width="300px" />
		      </tr>
		</table> 
<p> All the pieces of the puzzle are ready for building a full ray tracer with a GRIN lens! The Monte-Carlo ray tracing algorithm is modified to account for the GRIN lens as follows: the random (x, y) position is scaled according to FOV parameters and mapped to (-X, -Y, zi) on the focal plane (where zi is displacement of sensor plane solved for by thin lens equation),  a random point on lens back plane is sampled at random, a ray is traced linearly from sensor to lens back plane, the Euler integration technique traces rays through the GRIN lens, and finally the light ray exits the lens and is traced as normal. A trace that cannot successfully pass through the lens is returned as invalid and causes a 0 spectrum. This basic technique is very noisy due to many failed lens traces. Thus, random points on the lens are tried until a ray finally gets through to the other side or a max iteration cap is hit. In theory we should be dividing by the number of attempted rays (including fails) when computing the final Monte-Carlo estimation, but empirically doing so generated very dim images. Instead the ray tracer divides by the number of samples per pixel as usual, which correctly brightens the image. This change can be likened to applying a gain to the camera to generate brighter images. </p>

<p> Below are renders of CBbunny and CBdragon using the modified camera and GRIN lens at various quality levels and focused at various depths. Note that the GRIN lens behaves much like a thin lens with no visible aberration! This is pretty impressive considering it is a real physical component. The sensor field of view was chosen to be slightly larger than the lens radius to cause the vignette effect on the sides, where less light gets out to the scene. </p>

			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/bunny.png" width="300px" />
		        <figcaption align="middle"> 512 pixel rays 32 light rays 10 bounces </figcaption>
		       </tr>
		       <tr>
		        <td align="middle">
		        <img src="images/dragon128.png" width="300px" />
		        <figcaption align="middle"> 128 pixel rays 32 light rays 10 bounces </figcaption>
		        <td align="middle">
		        <img src="images/dragon512.png" width="300px" />
		        <figcaption align="middle"> 512 pixel rays 32 light rays 10 bounces</figcaption>
		      </tr>
			</table> 

<h2> References</h2>
Seron, F.j., D. Gutierrez, G. Gutierrez, and E. Cerezo. "Implementation of a Method of Curved Ray
Tracing for Inhomogeneous Atmospheres." Computers & Graphics 29.1 (2005): 95-108.Web.
<br>
"Gradient Index Lens." SPIE. International Society for Optics and Photonics, n.d. Web. 28 Apr. 2017.
<https://spie.org/publications/tt48_55_gradient_index_lens>.

<h2> Contributions from each team member</h2>
	Jennifer worked on implementing the slab technique and generated results for the Fata Morgana and Mirage scenes. Sudeep worked on implementing the Euler Integration technique in code, and generated the GRIN lens results. Both teammates worked on research, and together came up with the direction of the project. 
<h2> Overview</h2>


<table style="width=100%">
        <tr>
        <td align="middle">
        <figure> 
        <img src="images/mirage.jpeg" width="300px" />
        <figcaption align="middle"> Mirage </figcaption>

        <td align="middle">
        <img src="images/fata.jpeg" width="370px" />
        <figcaption align="middle"> Fata Morgana </figcaption>
        </figure> 
      </tr>
</table>

<h2> Outline </h2>

<h3> Section I: Mirage and Fata Morgana</h3>
	<h4> Part 1: Modeling Change of Air Density</h4>
		<p> To account for the change of index of refraction due to the change of air density, we implemented three different methods: Equal Slab Method, Alternative Slab Method, and Euler Ray Tracing Method. </p>
		<table style="width=100%">
		        <tr>
		        <td align="middle">
		        <figure>
		        <img src="images/mirageExplain.png" width="300px" align="middle"/>
		        <figcaption align="middle"> Mirage <br> (The index of refraction is smaller on the bottom than on the top)</figcaption>
		        </figure>
		        </td>
		      </tr>
		</table>

		<h5> Method 1: Equal Slab Method</h5>
		<p>In this method, we model the change of air density using horizontal slabs. Each slab is of equal height and each of the slab represents a different index of refraction. To get the value for a particular position on the image plan, we shoot a ray from that position into the scene. The ray travels in a straight line until it hits the boundary of the slab. We then use Snell's Law to calculate the new direction. This ray tracing continues until the ray either hits the boundary of the scene or a primitive in the scene. </p>
		<table style="width=100%">
		        <tr>
		        <td>
		        <figure> 
		        <img src="images/equalSlab.png" width="300px" />
		        <figcaption align="middle"> Fixed slab height<br></figcaption>
		        </figure>
		      </tr>
		</table>

		<p> The following are images rendered using different number of slabs. As one can see, if we only model the air with a small number of slabs, we create a lot of artifacts, and the image looks far from accurate. It takes 700 slabs to render a relatively accurate image. </p>
		<h5> Mirage </h5> 
		<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/mirage10.png" width="300px" />
		        <figcaption align="middle"> 10 slabs </figcaption>
		        <td align="middle">
		        <img src="images/mirage100.png" width="300px" />
		        <figcaption align="middle"> 100 slabs </figcaption>
		        <td align="middle">
		        <img src="images/mirage700.png" width="300px" />
		        <figcaption align="middle"> 700 slabs </figcaption>
		      </tr>
		</table>
		<h5> Fata Morgana </h5>
		<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/fata10.png" width="300px" />
		        <figcaption align="middle"> 10 slabs </figcaption>
		        <td align="middle">
		        <img src="images/fata100.png" width="300px" />
		        <figcaption align="middle"> 100 slabs </figcaption>
		        <td align="middle">
		        <img src="images/fata700.png" width="300px" />
		        <figcaption align="middle"> 700 slabs </figcaption>
		      </tr>
		</table>
		<h5> Method 2: Alternative Slab Method</h5>
			<p> However, the method mentioned earlier has two main problems, it takes too long to render and it requires a large number of slab to generate an approximately accurate image</p>
			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/modifiedmethod.png" width="300px" />
		        <figcaption align="middle"> Fix Ray Length</figcaption>
		      </tr>
			</table>
			<p> In this modified slab method, instead of fixing the height of the slab, we fix the ray length, such that the light is traveling the same distance within a slab. For rays with a smaller angle (with respect to the normal), it corresponds to a larger slab. </p>	
			<h5> Mirage </h5>		
			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/time_50_mirage.png" width="300px" />
		        <figcaption align="middle"> Time Step: 50 <br> (Low Resolution) </figcaption>
		        <td align="middle">
		        <img src="images/time_10_mirage.png" width="300px" />
		        <figcaption align="middle"> Time Step: 10 <br> (Moderate Resolution)</figcaption>
		        <td align="middle">
		        <img src="images/time_1_mirage.png" width="300px" />
		        <figcaption align="middle"> Time Step: 1 <br> (High Resolution)</figcaption>
		      </tr>
			</table> 
			<h5> Fata Morgana </h5>		
			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/time_50_fata.png" width="300px" />
		        <figcaption align="middle"> Time Step: 50 <br> (Low Resolution) </figcaption>
		        <td align="middle">
		        <img src="images/time_10_fata.png" width="300px" />
		        <figcaption align="middle"> Time Step: 10 <br> (Moderate Resolution)</figcaption>
		        <td align="middle">
		        <img src="images/time_1_fata.png" width="300px" />
		        <figcaption align="middle"> Time Step: 1 <br> (High Resolution)</figcaption>
		      </tr>
			</table> 
		<h5> Method 3: Euler Ray Tracing</h5>
		<p> In the previous two slab methods, we assume that index of refraction stays constant in points with the same height, however, more complex scenes will require us to relax that assumption. We solve the general case using general equation based on Fermat's principles.</p>

		<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/eq1.PNG" width="300px" />
		        <figcaption align="middle"> Source: F. J. Seron et. al. </figcaption>
		      </tr>
		</table> 

		<p> To solve discretize equation and Euler's method to estimate path. </p>
		<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/eq2.PNG" width="300px" />
		        <figcaption align="middle"> Source: F. J. Seron et. al. </figcaption>
		      </tr>
		</table> 

	<h4> Part 2: Modeling Heat Source</h4>
	<p> In a more complicated scene, the heat source might be more than just the entire floor. Using the previous example, only the red shaded area of the scene has a relatively higher temperature than the rest. 
			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/heatsource.png" width="300px"/>
		        <figcaption align="middle"> The red shade area is the heat source. </figcaption>
		      </tr>
			</table> 
			<br> 
			Here is a demonstration that we can set any box in the scene to have a different index of refraction from the surrouding area. </p>
			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/block_in_middle.png" width="300px" />
		        <figcaption align="middle"> The block has a 0.99 index of refraction, <br> while the rest of the area has 1 as index of refraction. </figcaption>
		      </tr>
			</table>


<h3> Section II: Application - Gradient-Index Optics (GRIN) </h3>

	<p> Modern camera lenses are made of different glass componenets. Each of the componenets has different index of refraction. These lenses combine together to work as an approximation ideal thin lens. Such combination deviates from the ideal thin lense models, so called aberrations. Aberrations cause visible artifacts in final images. </p>

	<p>Instead, we can use lenses whose index of refraction changes throughout the material. This way, we can create flat lenses and/or lenses without abberations. In thoery, the human eye also has varying index of refraction. </p>


	<h4> GRIN Lens Specifics</h4> 
		<ul>
		  <li> Index of Refraction: $N = N_0[1-(k/2)r^2]$</li>
		  <li> Focal Length: $f = \frac{1}{N_0 \sqrt{k} sin(t \sqrt{k})}$</li>
		  <li> Back Focal Length: $bfl = fcos(t \sqrt{k})$</li>
		  <li> $N_0$ is base index of refraction, $k$ is gradient constant, and $t$ is lens length
		</ul>
		<p>Source for all equations is International Society for Optics and Photonics <br> (Read more at: https://spie.org/publications/tt48_55_gradient_index_lens)</p>
	
	<h4> Ray Tracing From Sensor Plane to World </h4>
		

	<br> <br> 
	<h4> Some rendered images </h4> 

			<table style="width=100%">
			   <tr>
		        <td align="middle">
		        <img src="images/bunny.png" width="300px" />
		        <figcaption align="middle"> 512 pixel rays <br> 32 light rays <br> 10 bounces </figcaption>
		       </tr>
		       <tr>
		        <td align="middle">
		        <img src="images/dragon128.png" width="300px" />
		        <figcaption align="middle"> 128 pixel rays <br> 32 light rays <br> 10 bounces </figcaption>
		        <td align="middle">
		        <img src="images/dragon512.png" width="300px" />
		        <figcaption align="middle"> 512 pixel rays <br> 32 light rays <br> 10 bounces</figcaption>
		      </tr>
			</table> 

<p> Milestone resources</p>
<a href="https://www.youtube.com/watch?v=JY5fzc5d4aE">Milestone Video</a>
<br> 
<a href="https://docs.google.com/a/berkeley.edu/presentation/d/1DZWjTugHMejenjGKO1fG3UBtJUfPZmdph4qSLC1bUk0/edit?usp=sharing"> Presentation Slides </a>
</body>
</html>